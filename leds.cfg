[include stealthburner_leds.cfg]

[gcode_macro _police_leds]
variable_running: 0
variable_current: 0
variable_sequence: [
    {
        'logo':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.2, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.3, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.6, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.3, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.2, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'left':  {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'right': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
        'duration': 0.05,
    },
  ]
gcode:

[delayed_gcode flashing]
gcode:
    {% set cur = printer["gcode_macro _police_leds"].current|int %}
    {% set upd = printer["gcode_macro _police_leds"].sequence[cur] %}
    {% set running = printer["gcode_macro _police_leds"].running|int %}
    {% if running %}
        set_led led="sb_leds" red={upd["logo"].r} green={upd["logo"].g} blue={upd["logo"].b} white={upd["logo"].w} index=1 transmit=0
        set_led led="sb_leds" red={upd["left"].r} green={upd["left"].g} blue={upd["left"].b} white={upd["left"].w} index=2 transmit=0
        set_led led="sb_leds" red={upd["right"].r} green={upd["right"].g} blue={upd["right"].b} white={upd["right"].w} index=3 transmit=1
        SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=current VALUE={(cur + 1) % printer["gcode_macro _police_leds"].sequence|length}
        UPDATE_DELAYED_GCODE ID=flashing DURATION={upd["duration"]}
    {% endif %}

[gcode_macro flash]
gcode:
    SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=current VALUE=0
    SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=running VALUE=1
    UPDATE_DELAYED_GCODE ID=flashing DURATION=1

[gcode_macro stop_flashing]
gcode:
    SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=running VALUE=0
    UPDATE_DELAYED_GCODE ID=flashing DURATION=0
    set_led led="sb_leds" red=0 green=0 blue=0 white=0 index=1 transmit=0
    set_led led="sb_leds" red=0 green=0 blue=0 white=0 index=2 transmit=0
    set_led led="sb_leds" red=0 green=0 blue=0 white=0 index=3 transmit=1
