[include stealthburner_leds.cfg]

[gcode_macro _police_leds]
variable_running: 0
variable_current: 0
variable_sequence: [
    {
        'logo':  {},
        'left':  {},
        'right': {'r': 1.0},
        'duration': 0.1,
    },
    {
        'right': {},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.2},
        'right': {'r': 1.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.3},
        'right': {},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.6},
        'right': {'r': 1.0},
        'duration': 0.1,
    },
    {
        'right': {},
        'duration': 0.05,
    },
    {
        'left':  {'b': 1.0},
        'duration': 0.1,
    },
    {
        'logo':  {'r': 0.3},
        'left':  {},
        'duration': 0.05,
    },
    {
        'logo':  {'r': 0.2},
        'left':  {'b': 1.0},
        'duration': 0.1,
    },
    {
        'logo':  {},
        'left':  {},
        'duration': 0.05,
    },
    {
        'left':  {'b': 1.0},
        'duration': 0.1,
    },
    {
        'left':  {},
        'duration': 0.05,
    },
  ]
gcode:

[delayed_gcode flashing]
gcode:
    {% set cur = printer["gcode_macro _police_leds"].current|int %}
    {% set upd = printer["gcode_macro _police_leds"].sequence[cur] %}
    {% set running = printer["gcode_macro _police_leds"].running|int %}
    {% if running %}
        {% set logo_t = 0 %}
        {% set left_t = 0 %}
        {% set right_t = 0 %}
        {% if (upd["right"] is defined) %}
            {% set right_t = 1 %}
        {% elif (upd["left"] is defined) %}
            {% set left_t = 1 %}
        {% elif (upd["logo"] is defined) %}
            {% set logo_t = 1 %}
        {% endif %}

        {% if (upd["logo"] is defined) %}
            set_led led="sb_leds" red={upd["logo"].r|default(0)} green={upd["logo"].g|default(0)} blue={upd["logo"].b|default(0)} white={upd["logo"].w|default(0)} index=1 transmit={logo_t}
        {% endif %}
        {% if (upd["left"] is defined) %}
            set_led led="sb_leds" red={upd["left"].r|default(0)} green={upd["left"].g|default(0)} blue={upd["left"].b|default(0)} white={upd["left"].w|default(0)} index=2 transmit={left_t}
        {% endif %}
        {% if (upd["right"] is defined) %}
            set_led led="sb_leds" red={upd["right"].r|default(0)} green={upd["right"].g|default(0)} blue={upd["right"].b|default(0)} white={upd["right"].w|default(0)} index=3 transmit={right_t}
        {% endif %}
        SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=current VALUE={(cur + 1) % printer["gcode_macro _police_leds"].sequence|length}
        UPDATE_DELAYED_GCODE ID=flashing DURATION={upd["duration"]}
    {% endif %}

[gcode_macro flash]
gcode:
    SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=current VALUE=0
    SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=running VALUE=1
    UPDATE_DELAYED_GCODE ID=flashing DURATION=1

[gcode_macro stop_flashing]
gcode:
    SET_GCODE_VARIABLE MACRO=_police_leds VARIABLE=running VALUE=0
    UPDATE_DELAYED_GCODE ID=flashing DURATION=0
    set_led led="sb_leds" red=0 green=0 blue=0 white=0 index=1 transmit=0
    set_led led="sb_leds" red=0 green=0 blue=0 white=0 index=2 transmit=0
    set_led led="sb_leds" red=0 green=0 blue=0 white=0 index=3 transmit=1
